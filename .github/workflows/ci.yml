name: CI

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

permissions:
  contents: read
  security-events: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Verify go.mod and go.sum
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Run go fmt
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go files must be formatted with gofmt. Please run:"
            echo "  make fmt"
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@v2.21.4

      - name: Run gosec Security Scanner
        run: gosec -exclude-dir=test -exclude-dir=web -exclude-dir=node_modules -exclude-generated ./...

      - name: Run Trivy vulnerability scanner (table output)
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-results.txt'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Run Trivy vulnerability scanner (SARIF for GitHub Security)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Write Trivy results to job summary
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if grep -qE '(HIGH|CRITICAL)' trivy-results.txt 2>/dev/null; then
            echo "### âš ï¸ Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "HIGH or CRITICAL vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand scan results</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat trivy-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… No Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No HIGH or CRITICAL vulnerabilities detected." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for HIGH/CRITICAL vulnerabilities
        run: |
          if grep -qE '(HIGH|CRITICAL)' trivy-results.txt 2>/dev/null; then
            echo "::error::HIGH or CRITICAL vulnerabilities found!"
            cat trivy-results.txt
            exit 1
          else
            echo "No HIGH or CRITICAL vulnerabilities found."
          fi

  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web-app/package-lock.json

      - name: Install dependencies
        run: cd web-app && npm ci

      - name: Run tests with coverage
        id: frontend_test
        run: |
          cd web-app
          # Run tests with coverage (reporters configured in vitest.config.ts)
          npm run test:coverage 2>&1 | tee test-output.txt
          test_exit_code=${PIPESTATUS[0]}

          # Debug: show what we captured
          echo "=== Test output preview ==="
          cat test-output.txt | tail -20
          echo "==========================="

          # Parse test results from Vitest output
          # Vitest format: "      Tests  522 passed (522)" (with leading whitespace)
          # Use grep -E with more flexible pattern
          test_line=$(grep -E "^\s*Tests\s+" test-output.txt | tail -1 || echo "")
          echo "Test line found: '$test_line'"

          if [ -n "$test_line" ]; then
            # Extract total from parentheses at end: (522)
            total_tests=$(echo "$test_line" | grep -oE '\([0-9]+\)$' | tr -d '()' || echo "0")
            [ -z "$total_tests" ] && total_tests="0"

            # Extract passed count: "522 passed"
            passed_tests=$(echo "$test_line" | grep -oE '[0-9]+ passed' | head -1 | grep -oE '[0-9]+' || echo "0")
            [ -z "$passed_tests" ] && passed_tests="0"

            # Extract failed count (may not exist): "5 failed"
            failed_tests=$(echo "$test_line" | grep -oE '[0-9]+ failed' | head -1 | grep -oE '[0-9]+' || echo "0")
            [ -z "$failed_tests" ] && failed_tests="0"

            # Extract skipped count (may not exist): "3 skipped"
            skipped_tests=$(echo "$test_line" | grep -oE '[0-9]+ skipped' | head -1 | grep -oE '[0-9]+' || echo "0")
            [ -z "$skipped_tests" ] && skipped_tests="0"
          else
            total_tests="0"
            passed_tests="0"
            failed_tests="0"
            skipped_tests="0"
          fi

          # Parse coverage from text-summary - look for "All files" line
          coverage_line=$(grep "All files" test-output.txt | head -1 || echo "")
          if [ -n "$coverage_line" ]; then
            # Coverage format: "All files |   XX.XX |   XX.XX |   XX.XX |   XX.XX |"
            coverage=$(echo "$coverage_line" | awk -F'|' '{print $2}' | tr -d ' ' || echo "0")
            [ -z "$coverage" ] && coverage="0"
          else
            coverage="0"
          fi

          echo "total_tests=$total_tests" >> $GITHUB_OUTPUT
          echo "passed_tests=$passed_tests" >> $GITHUB_OUTPUT
          echo "failed_tests=$failed_tests" >> $GITHUB_OUTPUT
          echo "skipped_tests=$skipped_tests" >> $GITHUB_OUTPUT
          echo "coverage=$coverage" >> $GITHUB_OUTPUT

          echo "Frontend Tests: $passed_tests passed, $failed_tests failed, $skipped_tests skipped (total: $total_tests)"
          echo "Frontend Coverage: $coverage%"

          exit $test_exit_code

      - name: Write frontend test results to job summary
        if: always()
        run: |
          echo "## ðŸŽ¨ Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          total="${{ steps.frontend_test.outputs.total_tests }}"
          passed="${{ steps.frontend_test.outputs.passed_tests }}"
          failed="${{ steps.frontend_test.outputs.failed_tests }}"
          skipped="${{ steps.frontend_test.outputs.skipped_tests }}"
          coverage="${{ steps.frontend_test.outputs.coverage }}"

          # Determine test status emoji
          if [ "$failed" != "0" ] && [ -n "$failed" ]; then
            test_emoji="âŒ"
          else
            test_emoji="âœ…"
          fi

          echo "### Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| $test_emoji **Total Tests** | $total |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… **Passed** | $passed |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ **Failed** | $failed |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ **Skipped** | $skipped |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage section
          echo "### Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Statement Coverage** | ${coverage}% |" >> $GITHUB_STEP_SUMMARY

      - name: Build frontend
        run: cd web-app && npm run build

  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests with race detection
        id: go_test
        env:
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USER: postgres
          DATABASE_PASSWORD: postgres
          DATABASE_NAME: test_db
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          # Run tests and capture output
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./... 2>&1 | tee test-output.txt
          test_exit_code=${PIPESTATUS[0]}

          # Count tests - use grep with || true to prevent failure on no match
          passed_tests=$(grep -c "^--- PASS" test-output.txt 2>/dev/null || true)
          failed_tests=$(grep -c "^--- FAIL" test-output.txt 2>/dev/null || true)
          skipped_tests=$(grep -c "^--- SKIP" test-output.txt 2>/dev/null || true)

          # Ensure we have valid numbers (default to 0 if empty)
          passed_tests=${passed_tests:-0}
          failed_tests=${failed_tests:-0}
          skipped_tests=${skipped_tests:-0}
          total_tests=$((passed_tests + failed_tests + skipped_tests))

          echo "total_tests=$total_tests" >> $GITHUB_OUTPUT
          echo "passed_tests=$passed_tests" >> $GITHUB_OUTPUT
          echo "failed_tests=$failed_tests" >> $GITHUB_OUTPUT
          echo "skipped_tests=$skipped_tests" >> $GITHUB_OUTPUT

          echo "Backend Tests: $passed_tests passed, $failed_tests failed, $skipped_tests skipped (total: $total_tests)"

          exit $test_exit_code

      - name: Generate coverage report
        id: coverage
        run: |
          # Get total coverage percentage
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "coverage=$coverage" >> $GITHUB_OUTPUT
          echo "Total test coverage: ${coverage}%"

          # Generate per-package coverage summary
          go tool cover -func=coverage.out > coverage-summary.txt

          # Check threshold
          threshold=50
          if (( $(echo "$coverage < $threshold" | bc -l) )); then
            echo "below_threshold=true" >> $GITHUB_OUTPUT
            echo "Coverage ${coverage}% is below threshold ${threshold}%"
          else
            echo "below_threshold=false" >> $GITHUB_OUTPUT
          fi

      - name: Write backend test results to job summary
        if: always()
        run: |
          echo "## ðŸ§ª Backend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          total="${{ steps.go_test.outputs.total_tests }}"
          passed="${{ steps.go_test.outputs.passed_tests }}"
          failed="${{ steps.go_test.outputs.failed_tests }}"
          skipped="${{ steps.go_test.outputs.skipped_tests }}"
          coverage="${{ steps.coverage.outputs.coverage }}"
          below_threshold="${{ steps.coverage.outputs.below_threshold }}"

          # Determine test status emoji
          if [ "$failed" != "0" ] && [ -n "$failed" ]; then
            test_emoji="âŒ"
          else
            test_emoji="âœ…"
          fi

          echo "### Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| $test_emoji **Total Tests** | $total |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… **Passed** | $passed |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ **Failed** | $failed |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ **Skipped** | $skipped |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage section
          if [ "$below_threshold" = "true" ]; then
            coverage_emoji="ðŸ”´"
            status_text="âŒ Below threshold (50%)"
          else
            coverage_emoji="ðŸŸ¢"
            status_text="âœ… Meets threshold (50%)"
          fi

          echo "### Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| $coverage_emoji **Total Coverage** | ${coverage}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | $status_text |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Per-package breakdown (only if file exists)
          if [ -f coverage-summary.txt ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Per-package coverage breakdown</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -20 coverage-summary.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check coverage threshold
        run: |
          if [ "${{ steps.coverage.outputs.below_threshold }}" = "true" ]; then
            echo "::error::Coverage ${{ steps.coverage.outputs.coverage }}% is below threshold 50%"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          make build
          ls -lh bin/

      - name: Verify binary
        if: matrix.goos == 'linux'
        run: |
          file bin/mcp-gateway-${{ matrix.goos }}-${{ matrix.goarch }}
          # Verify it's a static binary
          if ldd bin/mcp-gateway-${{ matrix.goos }}-${{ matrix.goarch }} 2>&1 | grep -q "not a dynamic executable"; then
            echo "âœ… Binary is statically linked"
          else
            echo "âŒ Binary is not statically linked"
            exit 1
          fi

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcp-gateway-${{ matrix.goos }}-${{ matrix.goarch }}
          path: bin/mcp-gateway-${{ matrix.goos }}-${{ matrix.goarch }}
          retention-days: 7

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, security, frontend, test, build]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## ðŸ“Š CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Function to convert result to emoji
          get_emoji() {
            case "$1" in
              success) echo "âœ…" ;;
              failure) echo "âŒ" ;;
              cancelled) echo "â¹ï¸" ;;
              skipped) echo "â­ï¸" ;;
              *) echo "â“" ;;
            esac
          }

          echo "| Lint | $(get_emoji ${{ needs.lint.result }}) ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | $(get_emoji ${{ needs.security.result }}) ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $(get_emoji ${{ needs.frontend.result }}) ${{ needs.frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | $(get_emoji ${{ needs.test.result }}) ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | $(get_emoji ${{ needs.build.result }}) ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.frontend.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "### âŒ CI Pipeline Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### âœ… All CI Checks Passed" >> $GITHUB_STEP_SUMMARY
